<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–∏–≥–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { 
            --bg: #0f1621; --panel: #17212b; --text: #f5f5f5; --accent: #5288c1; 
            --accent-hover: #6599d1; --error: #ff5f5f; --msg-in: #182533; --msg-out: #2b5278; 
            --input-bg: #242f3d; --border: #232e3c; --context-bg: #1c242f;
            --read: #40a7e3; --quote-bar: #5288c1;
        }
        body.light-theme {
            --bg: #f0f2f5; --panel: #ffffff; --text: #000000; --accent: #0088cc;
            --accent-hover: #0077b5; --msg-in: #ffffff; --msg-out: #effdde;
            --input-bg: #f4f4f5; --border: #dfe1e5; --context-bg: #ffffff;
            --read: #4caf50; --quote-bar: #0088cc;
        }

        /* –ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        * { 
            -webkit-tap-highlight-color: transparent; 
            box-sizing: border-box; 
            user-select: none !important; 
            -webkit-user-select: none !important; 
            -ms-user-select: none !important;
            -moz-user-select: none !important;
        }

        /* –†–∞–∑—Ä–µ—à–∞–µ–º —Ä–∞–±–æ—Ç—É –∫—É—Ä—Å–æ—Ä–∞ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞, –Ω–æ –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º */
        input, textarea {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; position: fixed; width: 100%;
            transition: background 0.3s ease;
        }

        /* Animations */
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.4s ease; }
        .auth-box { 
            background: var(--panel); padding: 30px 20px; border-radius: 20px; width: 100%; max-width: 340px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); text-align: center; 
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .tabs { display: flex; margin-bottom: 20px; background: rgba(0,0,0,0.1); border-radius: 12px; padding: 4px; }
        .tab { flex: 1; padding: 12px; cursor: pointer; border-radius: 10px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.7; font-size: 14px; }
        .tab.active { opacity: 1; background: var(--accent); color: white; font-weight: 600; }

        header { 
            background: var(--panel); padding: 0 15px; height: 56px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); z-index: 10; flex-shrink: 0; 
            transition: background 0.3s;
        }
        .header-left, .header-right { display: flex; align-items: center; gap: 8px; }

        #chat-container { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; 
            background: var(--bg); -webkit-overflow-scrolling: touch; 
            transition: background 0.3s;
        }
        
        .message { 
            padding: 8px 12px; border-radius: 16px; background: var(--msg-in); align-self: flex-start; 
            max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.15); border: 1px solid var(--border); 
            position: relative; word-wrap: break-word;
            animation: msgIn 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.2) forwards;
            transition: background 0.3s;
            cursor: default;
        }
        .message.my { background: var(--msg-out); align-self: flex-end; border: none; transform-origin: right bottom; }
        .message:not(.my) { transform-origin: left bottom; }
        .message b { color: var(--accent); font-size: 13px; display: block; margin-bottom: 2px; }

        .text-content p { margin: 4px 0; }
        .text-content code { background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .text-content pre { 
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; overflow-x: auto; 
            font-family: monospace; margin: 5px 0; border-left: 3px solid var(--quote-bar);
        }
        
        .text-content blockquote {
            margin: 5px 0;
            padding: 2px 0 2px 12px;
            border-left: 3px solid var(--quote-bar);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px 6px 6px 2px;
        }

        .reactions-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .reaction-badge { 
            background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; 
            font-size: 12px; display: flex; align-items: center; gap: 3px; border: 1px solid rgba(255,255,255,0.05);
            animation: pop 0.2s ease;
        }

        .msg-info { 
            font-size: 10px; opacity: 0.6; margin-top: 2px; display: flex; align-items: center; 
            justify-content: flex-end; gap: 4px; 
        }
        .status-icon { display: flex; align-items: center; transition: color 0.3s; }

        .reply-preview { 
            background: rgba(0,0,0,0.1); border-left: 3px solid var(--accent); padding: 4px 8px; 
            font-size: 11px; margin-bottom: 4px; border-radius: 4px; opacity: 0.8; cursor: pointer; 
            transition: background 0.2s;
        }

        .input-area { background: var(--panel); padding: 8px 12px 12px 12px; border-top: 1px solid var(--border); z-index: 10; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        #reply-bar, #edit-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.05); padding: 8px 12px; border-radius: 12px 12px 0 0; 
            font-size: 12px; border-bottom: 1px solid var(--accent); margin-bottom: 4px; 
            animation: fadeIn 0.3s ease;
        }
        .input-row { display: flex; gap: 8px; align-items: center; }

        input { 
            background: var(--input-bg); border: 1px solid var(--border); color: var(--text); 
            padding: 10px 14px; border-radius: 20px; outline: none; width: 100%; box-sizing: border-box; font-size: 16px; 
            transition: border-color 0.2s, background 0.3s;
            -webkit-appearance: none;
        }
        input:focus { border-color: var(--accent); }

        .btn-main { 
            background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 20px; 
            font-weight: 600; cursor: pointer; font-size: 14px; flex-shrink: 0; 
            transition: transform 0.1s, background 0.2s;
        }
        .btn-main:active { transform: scale(0.95); }

        .icon-btn { 
            cursor: pointer; background: none; border: none; color: var(--accent); 
            padding: 8px; border-radius: 50%; display: flex; align-items: center; 
            transition: background 0.2s, transform 0.2s; 
        }
        .icon-btn:active { background: rgba(0,0,0,0.1); transform: scale(0.9); }

        #context-menu { 
            position: fixed; background: var(--context-bg); border: 1px solid var(--border); 
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 3000; 
            min-width: 220px; display: none; overflow: hidden; 
            transform-origin: center;
            animation: pop 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .context-item { padding: 12px 16px; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .context-item:active { background: rgba(255,255,255,0.08); }
        .context-item.danger { color: var(--error); }
        
        .reaction-picker { display: flex; justify-content: space-around; padding: 10px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1); }
        .emoji-btn { font-size: 20px; cursor: pointer; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); padding: 5px; }

        #settings-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; 
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); 
            padding: 20px; animation: fadeIn 0.3s ease;
        }
        .modal-content { 
            background: var(--panel); padding: 25px; border-radius: 24px; width: 100%; max-width: 300px; 
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .hidden { display: none !important; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(120, 120, 120, 0.3); border-radius: 10px; }
    </style>
</head>
<body class="dark-theme" oncontextmenu="return false;">

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="margin: 0 0 20px 0; font-size: 20px;">–õ–∏–≥–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö</h2>
        <div class="tabs">
            <div class="tab active" id="tab-login">–í—Ö–æ–¥</div>
            <div class="tab" id="tab-reg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
        <div id="auth-form">
            <input type="text" id="auth-user" placeholder="–õ–æ–≥–∏–Ω" autocomplete="off" style="margin-bottom:10px">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" style="margin-bottom:10px">
            <div id="reg-fields" class="hidden">
                <input type="password" id="auth-pass-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è" style="margin-bottom:10px">
                <input type="password" id="auth-invite" placeholder="–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞" style="margin-bottom:10px">
            </div>
            <button id="auth-btn" class="btn-main" style="width:100%; border-radius: 12px;">–í–æ–π—Ç–∏</button>
            <div id="auth-error" style="color:var(--error); font-size:12px; margin-top:12px; min-height: 14px;"></div>
        </div>
    </div>
</div>

<div id="context-menu"></div>

<div id="settings-modal">
    <div class="modal-content">
        <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <button id="toggle-theme-btn" class="btn-main" style="width:100%; margin-bottom:12px; background: transparent; border: 1px solid var(--accent); color: var(--accent);">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
        <button id="close-settings-btn" class="btn-main" style="width:100%">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<header>
    <div class="header-left">
        <button class="icon-btn" id="open-settings-btn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
        <span style="font-weight:700">–õ–∏–≥–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö</span>
    </div>
    <div class="header-right">
        <span id="user-display" style="font-size:12px; opacity:0.8"></span>
        <button id="global-logout-btn" class="icon-btn" style="color:var(--error)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </div>
</header>

<div id="chat-container"></div>

<div class="input-area">
    <div id="reply-bar" class="hidden">
        <span id="reply-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%;">–û—Ç–≤–µ—Ç...</span>
        <span id="cancel-reply-btn" style="padding: 4px; cursor: pointer;">‚úï</span>
    </div>
    <div id="edit-bar" class="hidden">
        <span id="edit-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</span>
        <span id="cancel-edit-btn" style="padding: 4px; cursor: pointer;">‚úï</span>
    </div>
    <div class="input-row">
        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." enterkeyhint="send" autocomplete="off">
        <button id="send-btn" class="btn-main">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display: block;"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0VcGrjDffZ3FCD7x9KSJ79ujeLFTbC-o",
        authDomain: "testy-talk.firebaseapp.com",
        databaseURL: "https://testy-talk-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "testy-talk",
        storageBucket: "testy-talk.firebasestorage.app",
        messagingSenderId: "172541851795",
        appId: "1:172541851795:web:af233412e9e47016dbb566"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = localStorage.getItem('chat_user');
    let replyingTo = null;
    let editingMsg = null;
    let isLoginMode = true;
    let deletedForMe = JSON.parse(localStorage.getItem('deleted_msgs') || '{}');
    const TARGET_CODE = "roboticteam548";

    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');

    marked.setOptions({ breaks: true, gfm: true });

    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // --- AUTH ---
    const tabLogin = document.getElementById('tab-login');
    const tabReg = document.getElementById('tab-reg');
    const regFields = document.getElementById('reg-fields');
    const authBtn = document.getElementById('auth-btn');
    const errorEl = document.getElementById('auth-error');

    tabLogin.onclick = () => { isLoginMode = true; tabLogin.classList.add('active'); tabReg.classList.remove('active'); regFields.classList.add('hidden'); authBtn.innerText = "–í–æ–π—Ç–∏"; };
    tabReg.onclick = () => { isLoginMode = false; tabReg.classList.add('active'); tabLogin.classList.remove('active'); regFields.classList.remove('hidden'); authBtn.innerText = "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç"; };

    authBtn.onclick = async () => {
        const user = document.getElementById('auth-user').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value.trim();
        if(!user || !pass) return errorEl.innerText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";

        const userRef = ref(db, 'users/' + user);
        const snap = await get(userRef);
        const hashedPass = await hashPassword(pass);

        if (isLoginMode) {
            if (snap.exists() && snap.val().password === hashedPass) login(user);
            else errorEl.innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
        } else {
            const passConfirm = document.getElementById('auth-pass-confirm').value.trim();
            const inviteCode = document.getElementById('auth-invite').value.trim();
            if (snap.exists()) return errorEl.innerText = "–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç";
            if (pass !== passConfirm) return errorEl.innerText = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç";
            if (inviteCode !== TARGET_CODE) return errorEl.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥";
            await set(userRef, { password: hashedPass });
            login(user);
        }
    };

    function login(u) {
        currentUser = u;
        localStorage.setItem('chat_user', u);
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('user-display').innerText = "@" + u;
        initChat();
    }
    if(currentUser) login(currentUser);

    // --- SETTINGS ---
    document.getElementById('open-settings-btn').onclick = () => document.getElementById('settings-modal').style.display = 'flex';
    document.getElementById('close-settings-btn').onclick = () => document.getElementById('settings-modal').style.display = 'none';
    document.getElementById('toggle-theme-btn').onclick = () => {
        const isLight = document.body.classList.toggle('light-theme');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
    };
    document.getElementById('global-logout-btn').onclick = () => { localStorage.removeItem('chat_user'); location.reload(); };

    // --- CHAT ---
    const chat = document.getElementById('chat-container');
    const msgInput = document.getElementById('message-input');

    function initChat() {
        onChildAdded(ref(db, 'chat_messages'), (snap) => {
            renderMsg(snap.key, snap.val());
            markAsRead(snap.key, snap.val());
        });
        onChildChanged(ref(db, 'chat_messages'), (snap) => {
            const el = document.getElementById("msg-" + snap.key);
            if(el) el.innerHTML = getMsgInner(snap.key, snap.val());
            markAsRead(snap.key, snap.val());
        });
        onChildRemoved(ref(db, 'chat_messages'), (snap) => {
            const el = document.getElementById("msg-" + snap.key);
            if(el) {
                el.style.animation = "pop 0.2s ease reverse forwards";
                setTimeout(() => el.remove(), 200);
            }
        });
    }

    async function markAsRead(id, data) {
        if (data.username !== currentUser) {
            const readBy = data.readBy || [];
            if (!readBy.includes(currentUser)) {
                readBy.push(currentUser);
                await update(ref(db, 'chat_messages/' + id), { readBy });
            }
        }
    }

    function renderMsg(id, data) {
        if(deletedForMe[id]) return;
        const div = document.createElement('div');
        div.className = `message ${data.username === currentUser ? 'my' : ''}`;
        div.id = "msg-" + id;
        div.innerHTML = getMsgInner(id, data);

        let pressTimer;
        const startPress = (e) => { 
            pressTimer = setTimeout(() => showContext(e, id, data), 600); 
        };
        const cancelPress = () => clearTimeout(pressTimer);

        div.addEventListener('touchstart', startPress, {passive: true});
        div.addEventListener('touchend', cancelPress);
        div.addEventListener('touchmove', cancelPress);
        div.addEventListener('contextmenu', (e) => { 
            e.preventDefault(); 
            e.stopPropagation(); 
            showContext(e, id, data); 
        });

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function getMsgInner(id, data) {
        const reply = data.replyTo ? `<div class="reply-preview" onclick="window.scrollToMsg('${data.replyTo.id}')"><b>${data.replyTo.user}</b>${data.replyTo.text.substring(0,30)}...</div>` : '';
        const edited = data.edited ? ' (–∏–∑–º.)' : '';
        const mdText = marked.parse(data.text);
        
        let reactionsHtml = '';
        if (data.reactions) {
            reactionsHtml = '<div class="reactions-list">';
            for (const [emoji, users] of Object.entries(data.reactions)) {
                reactionsHtml += `<div class="reaction-badge"><span>${emoji}</span><span>${users.length}</span></div>`;
            }
            reactionsHtml += '</div>';
        }

        let status = '';
        if (data.username === currentUser) {
            const isRead = data.readBy && data.readBy.length > 0;
            status = `<div class="status-icon" style="color:${isRead ? 'var(--read)' : 'inherit'}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M20 6L9 17L4 12"></path>
                    ${isRead ? '<path d="M16 6L9 13L7 11" opacity="0.8"></path>' : ''}
                </svg>
            </div>`;
        }

        return `
            ${reply}
            <b>${data.username}</b>
            <div class="text-content">${mdText}</div>
            ${reactionsHtml}
            <div class="msg-info">
                ${new Date(data.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${edited}
                ${status}
            </div>`;
    }

    // --- ACTIONS ---
    window.addReaction = async (id, emoji) => {
        const snap = await get(ref(db, 'chat_messages/' + id));
        if (!snap.exists()) return;
        const data = snap.val();
        let reactions = data.reactions || {};
        let users = reactions[emoji] || [];
        
        if (users.includes(currentUser)) {
            users = users.filter(u => u !== currentUser);
        } else {
            users.push(currentUser);
        }

        if (users.length === 0) delete reactions[emoji];
        else reactions[emoji] = users;

        await update(ref(db, 'chat_messages/' + id), { reactions });
        document.getElementById('context-menu').style.display = 'none';
    };

    window.showReadBy = async (e, id) => {
        e.stopPropagation();
        const snap = await get(ref(db, 'chat_messages/' + id));
        if (!snap.exists()) return;
        const data = snap.val();
        const readers = data.readBy || [];
        const menu = document.getElementById('context-menu');
        
        menu.innerHTML = `
            <div class="context-item" style="font-weight:bold; background: rgba(0,0,0,0.1)">üëÄ –ü—Ä–æ—á–∏—Ç–∞–ª–∏:</div>
            ${readers.length ? readers.map(r => `<div class="context-item">@${r}</div>`).join('') : '<div class="context-item" style="opacity:0.5">–ù–∏–∫—Ç–æ</div>'}
            <div class="context-item" style="color:var(--accent); justify-content: center; font-weight: 600" onclick="document.getElementById('context-menu').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</div>
        `;
    };

    window.scrollToMsg = (id) => {
        const el = document.getElementById("msg-" + id);
        if(el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.style.transition = "box-shadow 0.3s, transform 0.3s";
            el.style.boxShadow = "0 0 15px var(--accent)";
            el.style.transform = "scale(1.05)";
            setTimeout(() => {
                el.style.boxShadow = "";
                el.style.transform = "";
            }, 1000);
        }
    };

    window.copyMsgText = (text) => {
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        document.getElementById('context-menu').style.display = 'none';
    };

    window.setReply = (id, user, text) => {
        window.cancelInputState();
        replyingTo = { id, user, text };
        document.getElementById('reply-bar').classList.remove('hidden');
        document.getElementById('reply-text').innerText = "–û—Ç–≤–µ—Ç " + user;
        msgInput.focus();
        document.getElementById('context-menu').style.display = 'none';
    };

    window.setEdit = (id, text) => {
        window.cancelInputState();
        editingMsg = { id, text };
        document.getElementById('edit-bar').classList.remove('hidden');
        msgInput.value = text;
        msgInput.focus();
        document.getElementById('context-menu').style.display = 'none';
    };

    window.deleteForAll = (id) => { 
        remove(ref(db, 'chat_messages/' + id)); 
        document.getElementById('context-menu').style.display = 'none'; 
    };

    window.deleteForMeLocal = (id) => {
        deletedForMe[id] = true;
        localStorage.setItem('deleted_msgs', JSON.stringify(deletedForMe));
        const el = document.getElementById("msg-" + id);
        if(el) {
            el.style.animation = "pop 0.2s ease reverse forwards";
            setTimeout(() => el.remove(), 200);
        }
        document.getElementById('context-menu').style.display = 'none';
    };

    window.cancelInputState = () => {
        replyingTo = null; 
        editingMsg = null;
        document.getElementById('reply-bar').classList.add('hidden');
        document.getElementById('edit-bar').classList.add('hidden');
        msgInput.value = "";
    };

    document.getElementById('cancel-reply-btn').onclick = window.cancelInputState;
    document.getElementById('cancel-edit-btn').onclick = window.cancelInputState;

    function showContext(e, id, data) {
        const menu = document.getElementById('context-menu');
        menu.style.display = 'block';

        const touch = e.touches ? e.touches[0] : e;
        let x = touch.clientX;
        let y = touch.clientY;

        if (x + 220 > window.innerWidth) x = window.innerWidth - 230;
        if (y + 350 > window.innerHeight) y = window.innerHeight - 360;

        menu.style.left = x + 'px';
        menu.style.top = y + 'px';

        const isMy = data.username === currentUser;
        const safeTxt = data.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

        menu.innerHTML = `
            <div class="reaction-picker">
                <span class="emoji-btn" onclick="window.addReaction('${id}', 'üëç')">üëç</span>
                <span class="emoji-btn" onclick="window.addReaction('${id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="emoji-btn" onclick="window.addReaction('${id}', 'üî•')">üî•</span>
                <span class="emoji-btn" onclick="window.addReaction('${id}', 'üòÇ')">üòÇ</span>
                <span class="emoji-btn" onclick="window.addReaction('${id}', 'üòÆ')">üòÆ</span>
            </div>
            <div class="context-item" onclick="window.copyMsgText('${safeTxt}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
            <div class="context-item" onclick="window.setReply('${id}', '${data.username}', '${safeTxt}')">‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å</div>
            ${isMy ? `<div class="context-item" onclick="window.setEdit('${id}', '${safeTxt}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</div>` : ''}
            ${isMy ? `<div class="context-item" onclick="window.showReadBy(event, '${id}')">‚ÑπÔ∏è –ö—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª</div>` : ''}
            ${isMy ? `<div class="context-item danger" onclick="window.deleteForAll('${id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–µ–∑–¥–µ</div>` : ''}
            <div class="context-item danger" onclick="window.deleteForMeLocal('${id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É —Å–µ–±—è</div>
        `;
    }

    document.getElementById('send-btn').onclick = async () => {
        const val = msgInput.value.trim();
        if(!val) return;
        if(editingMsg) {
            await update(ref(db, 'chat_messages/' + editingMsg.id), { text: val, edited: true });
        } else {
            await push(ref(db, 'chat_messages'), {
                username: currentUser,
                text: val,
                time: Date.now(),
                replyTo: replyingTo,
                readBy: []
            });
        }
        window.cancelInputState();
    };

    msgInput.onkeydown = (e) => { 
        if(e.key === 'Enter') document.getElementById('send-btn').click(); 
    };

    window.addEventListener('contextmenu', (e) => {
        e.preventDefault();
    });

    window.addEventListener('click', (e) => {
        if(!e.target.closest('#context-menu')) {
            document.getElementById('context-menu').style.display = 'none';
        }
    });

</script>
</body>
</html>
